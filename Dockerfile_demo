# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#   ğŸ³ Chorely backend â€“ demoâ€‘day Dockerfile
#   â€¢ builds TypeScript once, runs **compiled JS** â†’ fast startup
#   â€¢ installs only prod deps in runtime image
#   â€¢ keeps migrations/seeds so container can selfâ€‘bootstrap
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

######################## 1ï¸âƒ£  builder stage ########################
FROM node:18-alpine AS builder
WORKDIR /app

COPY package*.json ./
RUN npm ci --ignore-scripts --prefer-offline

# copy source and build TypeScript â†’ dist/
COPY . ./
RUN npm run build  # outputs compiled JS to /app/dist

######################## 2ï¸âƒ£  runtime stage ########################
FROM node:18-alpine
WORKDIR /app

# copy prod deps only (shrinks image, speeds coldâ€‘start)
COPY --from=builder /app/package*.json ./
RUN npm ci --omit=dev --prefer-offline --ignore-scripts

# copy compiled JS + knex artefacts + waitâ€‘script
COPY --from=builder /app/dist        ./dist
COPY --from=builder /app/src/db      ./src/db

# runtime needs `pg_isready` used in start.sh
RUN apk add --no-cache postgresql-client

EXPOSE 4000
ENV NODE_ENV=production

# entrypoint: wait for Postgres â†’ migrate â†’ seed â†’ run compiled app
CMD ["./start.sh", "prod"]
